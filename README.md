<div align="center">

![Spring Boot](https://img.shields.io/badge/Spring%20Boot-white?logo=springboot&logoColor=6DB33F)
![Keycloak](https://img.shields.io/badge/Keycloak-23-blue?logo=keycloak)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

</div>

# ğŸ¥ PharmaChain - Enterprise Pharmaceutical Delivery Management Platform

> **A production-ready, security-first pharmaceutical logistics system with enterprise-grade authentication, role-based access control, and real-time delivery tracking.**

## ğŸ“‹ Table of Contents

- [Overview](#-overview)
- [System Architecture](#-system-architecture)
- [Security & Authentication](#-security--authentication-deep-dive)
- [Technology Stack](#-technology-stack)
- [Key Features](#-key-features)
- [Getting Started](#-getting-started)
- [Project Structure](#-project-structure)
- [Database Architecture](#-database-architecture)
- [API Overview](#-api-overview)
- [Deployment](#-deployment)

***

## ğŸ¯ Overview

**PharmaChain** is an enterprise-grade pharmaceutical delivery management system designed for large-scale logistics operations. It provides comprehensive tracking, management, and security features for medication distribution chains.

### Business Use Case

- **Pharmaceutical Distributors** managing multi-region delivery operations
- **Logistics Companies** tracking medication shipments with proof-of-delivery
- **Healthcare Supply Chains** requiring audit trails and compliance tracking
- **Multi-tenant Operations** with hierarchical role separation (Admin â†’ Manager â†’ Driver)

### Why PharmaChain?

âœ… **Enterprise Security** - OAuth2/OpenID Connect with Keycloak  
âœ… **Zero-Trust Architecture** - JWT-based stateless authentication  
âœ… **Dual-Database Design** - Separation of authentication and business logic  
âœ… **Role-Based Access Control** - Fine-grained permissions at method level  
âœ… **Audit Trail** - Complete tracking of all operations  
âœ… **Production-Ready** - Scalable, containerized, and cloud-native  

***

## ğŸ— System Architecture

### High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            CLIENT LAYER (Browser)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Next.js 14 Application (Port 3000)                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚ â”‚
â”‚  â”‚  â”‚ Login Page   â”‚  â”‚  Dashboard   â”‚  â”‚ Management   â”‚                 â”‚ â”‚
â”‚  â”‚  â”‚ (Public)     â”‚  â”‚  (Protected) â”‚  â”‚ Components   â”‚                 â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘  User Login Request
                               â”‚ (username, password)
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTHENTICATION LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Next.js Server Actions ("use server")                      â”‚ â”‚
â”‚  â”‚  â€¢ Protects client_secret from browser exposure                        â”‚ â”‚
â”‚  â”‚  â€¢ Acts as secure proxy between frontend and Keycloak                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘¡ OAuth2 Token Request
                               â”‚ POST /realms/.../token
                               â”‚ (client_id, client_secret, username, password)
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     IDENTITY & ACCESS MANAGEMENT                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            Keycloak 23.0 (Identity Provider - Port 8180)               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  â”‚ User Store   â”‚  â”‚  Role Engine â”‚  â”‚ Token Issuer â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ (LDAP/DB)    â”‚  â”‚  (RBAC)      â”‚  â”‚ (JWT/RS256)  â”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Responsibilities:                                                      â”‚ â”‚
â”‚  â”‚  â€¢ Password verification (PBKDF2 hashing)                              â”‚ â”‚
â”‚  â”‚  â€¢ JWT token generation (access + refresh tokens)                      â”‚ â”‚
â”‚  â”‚  â€¢ Role assignment and management                                      â”‚ â”‚
â”‚  â”‚  â€¢ User lifecycle management                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                               â”‚                                              â”‚
â”‚                               â”‚ â‘¢ Tokens Response                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  {                                                                      â”‚ â”‚
â”‚  â”‚    "access_token": "eyJhbGci...",  â† 15-min lifespan                  â”‚ â”‚
â”‚  â”‚    "refresh_token": "eyJhbG...",   â† 30-min lifespan                  â”‚ â”‚
â”‚  â”‚    "token_type": "Bearer",                                             â”‚ â”‚
â”‚  â”‚    "expires_in": 900                                                   â”‚ â”‚
â”‚  â”‚  }                                                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘£ Return tokens to frontend
                               â”‚ (Stored in localStorage + React Context)
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT STATE LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Auth Context (React Context API)                           â”‚ â”‚
â”‚  â”‚  â€¢ Manages authentication state                                         â”‚ â”‚
â”‚  â”‚  â€¢ Stores JWT tokens in localStorage                                    â”‚ â”‚
â”‚  â”‚  â€¢ Decodes JWT claims (user info, roles)                               â”‚ â”‚
â”‚  â”‚  â€¢ Provides user context to all components                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘¤ API Request with JWT
                               â”‚ Authorization: Bearer eyJhbGci...
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APPLICATION LAYER                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          Spring Boot 3.x REST API (Port 8080)                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  â”‚ Controllers  â”‚  â”‚   Services   â”‚  â”‚ Repositories â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ (REST API)   â”‚  â”‚  (Business   â”‚  â”‚ (Data Access)â”‚                â”‚ â”‚
â”‚  â”‚  â”‚              â”‚â†’ â”‚   Logic)     â”‚â†’ â”‚              â”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘¥ JWT Validation (Stateless)
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SECURITY LAYER                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       Spring Security 6.x (OAuth2 Resource Server)                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚  JWT Validation Pipeline (No Keycloak calls!)                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘  Extract JWT from Authorization header                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘¡ Decode JWT structure (header.payload.signature)             â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘¢ Verify RSA-256 Signature                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Uses Keycloak's public key (cached at startup)           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Cryptographic proof token wasn't tampered with           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘£ Check Expiration (exp claim)                                â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Reject if > 15 minutes old                               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘¤ Validate Issuer (iss claim)                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Must match configured Keycloak realm                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘¥ Extract Roles (realm_access.roles)                          â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Map to Spring GrantedAuthority                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Add ROLE_ prefix (e.g., ROLE_ADMIN)                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â†“                                                           â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â‘¦ Store in SecurityContext                                    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚     â€¢ Available to all @PreAuthorize checks                    â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  If validation fails at ANY step â†’ 401 Unauthorized                   â”‚ â”‚
â”‚  â”‚  If validation passes â†’ Execute controller method                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘¦ Authorization Check
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AUTHORIZATION LAYER                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Method-Level Security (@PreAuthorize)                      â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  Example: @PreAuthorize("hasRole('ADMIN')")                            â”‚ â”‚
â”‚  â”‚           public ResponseEntity<Admin> createAdmin(...)                â”‚ â”‚
â”‚  â”‚                                                                         â”‚ â”‚
â”‚  â”‚  â€¢ Spring Security checks if JWT contains ROLE_ADMIN                   â”‚ â”‚
â”‚  â”‚  â€¢ Allows/denies method execution based on roles                       â”‚ â”‚
â”‚  â”‚  â€¢ Fine-grained control at individual endpoint level                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ â‘§ Execute Business Logic
                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA LAYER                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Keycloak Database       â”‚         â”‚  Business Database       â”‚          â”‚
â”‚  â”‚  (PostgreSQL - Port 5432)â”‚         â”‚  (PostgreSQL - Port 5433)â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
â”‚  â”‚  â”‚ User Credentials   â”‚  â”‚         â”‚  â”‚ Users (keycloak_   â”‚ â”‚          â”‚
â”‚  â”‚  â”‚ (Hashed Passwords) â”‚  â”‚         â”‚  â”‚ user_id linkage)   â”‚ â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚          â”‚
â”‚  â”‚  â”‚ Realm Config       â”‚  â”‚         â”‚  â”‚ Bordereaux         â”‚ â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚          â”‚
â”‚  â”‚  â”‚ Role Definitions   â”‚  â”‚         â”‚  â”‚ Delivery Items     â”‚ â”‚          â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚          â”‚
â”‚  â”‚  â”‚ User Attributes    â”‚  â”‚         â”‚  â”‚ Clients            â”‚ â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚          â”‚
â”‚  â”‚                          â”‚         â”‚  â”‚ Transfers          â”‚ â”‚          â”‚
â”‚  â”‚  Managed by Keycloak     â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  Managed by Spring JPA â”‚          â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                              â”‚
â”‚  ğŸ” Security Principle: Separation of Concerns                              â”‚
â”‚  â€¢ Authentication data isolated from business data                          â”‚
â”‚  â€¢ Keycloak database never accessed by application                          â”‚
â”‚  â€¢ Business database only stores non-sensitive user references              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vault LAYER                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ store sensitive information (.env of front and back and docker compose) â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Flow Example: Admin Creates New User

```
â‘  Frontend: Admin clicks "Create Manager" button
   â†“
â‘¡ Frontend: Calls authenticatedFetch() with JWT in header
   â†“
â‘¢ Backend: Spring Security intercepts request
   â†“
â‘£ Backend: Validates JWT signature using Keycloak public key
   â†“
â‘¤ Backend: Checks @PreAuthorize("hasRole('ADMIN')")
   â†“
â‘¥ Backend: Calls KeycloakAdminService.createUser()
   â”‚
   â”œâ”€â†’ â‘¦ Keycloak: Creates user in Keycloak database
   â”‚      â€¢ Stores hashed password
   â”‚      â€¢ Assigns MANAGER role
   â”‚      â€¢ Returns Keycloak User ID (UUID)
   â”‚
   â””â”€â†’ â‘§ Database: Creates user record in business database
          â€¢ Links to Keycloak User ID
          â€¢ Stores business attributes (code, phone, sector)
          â€¢ References relationships (assigned admin, drivers)
          â†“
â‘¨ Response: Returns created user to frontend
   â†“
â‘© Frontend: Updates UI, shows success message
```

***

## ğŸ”’ Security & Authentication Deep Dive

### Zero-Trust Security Model

PharmaChain implements a **zero-trust architecture** where every request is authenticated and authorized independently, without relying on session state.

### Authentication Flow (OAuth2 ROPC)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTHENTICATION LIFECYCLE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: USER LOGIN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User enters  â”‚
â”‚ credentials  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js Server Action ("use server")          â”‚
â”‚ â€¢ Client secret NEVER sent to browser         â”‚
â”‚ â€¢ Server-side only execution                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ POST /realms/spring-boot-realm/protocol/openid-connect/token
         â”‚ Body: client_id, client_secret, username, password
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Keycloak Token Endpoint                        â”‚
â”‚ â€¢ Verifies password hash (PBKDF2)             â”‚
â”‚ â€¢ Checks user is enabled                       â”‚
â”‚ â€¢ Generates JWT with RSA-256 private key       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ Returns JSON
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Response                                 â”‚
â”‚ {                                              â”‚
â”‚   "access_token": "eyJhbGci...",              â”‚
â”‚   "refresh_token": "eyJhbGc...",              â”‚
â”‚   "expires_in": 900,  // 15 minutes           â”‚
â”‚   "token_type": "Bearer"                       â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend stores in:                            â”‚
â”‚ â€¢ localStorage (access_token)                  â”‚
â”‚ â€¢ localStorage (refresh_token)                 â”‚
â”‚ â€¢ React Context (user object)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 2: API REQUEST (Every subsequent call)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User action  â”‚
â”‚ (e.g., fetch â”‚
â”‚ admins list) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Client adds header:                        â”‚
â”‚ Authorization: Bearer eyJhbGci...              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ HTTP GET /api/admins
         â”‚ Header: Authorization: Bearer <token>
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Spring Security Filter Chain                   â”‚
â”‚                                                â”‚
â”‚ â‘  Bearer Token Extraction                     â”‚
â”‚    â€¢ Reads Authorization header                â”‚
â”‚    â€¢ Extracts token after "Bearer "            â”‚
â”‚                                                â”‚
â”‚ â‘¡ JWT Parsing                                 â”‚
â”‚    â€¢ Splits into: header.payload.signature    â”‚
â”‚    â€¢ Base64 decodes each part                  â”‚
â”‚                                                â”‚
â”‚ â‘¢ Signature Verification (CRITICAL)           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ Uses Keycloak's PUBLIC KEY          â”‚   â”‚
â”‚    â”‚ â€¢ Fetched once at startup            â”‚   â”‚
â”‚    â”‚ â€¢ Cached in memory                   â”‚   â”‚
â”‚    â”‚ â€¢ No network call to Keycloak!       â”‚   â”‚
â”‚    â”‚                                      â”‚   â”‚
â”‚    â”‚ Verification Algorithm:              â”‚   â”‚
â”‚    â”‚ RSA_verify(                          â”‚   â”‚
â”‚    â”‚   message: header + payload,         â”‚   â”‚
â”‚    â”‚   signature: JWT signature,          â”‚   â”‚
â”‚    â”‚   publicKey: Keycloak public key     â”‚   â”‚
â”‚    â”‚ )                                    â”‚   â”‚
â”‚    â”‚                                      â”‚   â”‚
â”‚    â”‚ Result:                              â”‚   â”‚
â”‚    â”‚ âœ… Valid = Token signed by Keycloak â”‚   â”‚
â”‚    â”‚ âŒ Invalid = Token tampered/forged  â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                â”‚
â”‚ â‘£ Expiration Check                            â”‚
â”‚    â€¢ Reads "exp" claim from payload            â”‚
â”‚    â€¢ Compares to current Unix timestamp        â”‚
â”‚    â€¢ Rejects if token > 15 minutes old         â”‚
â”‚                                                â”‚
â”‚ â‘¤ Issuer Validation                           â”‚
â”‚    â€¢ Reads "iss" claim                         â”‚
â”‚    â€¢ Must equal configured Keycloak URL        â”‚
â”‚                                                â”‚
â”‚ â‘¥ Role Extraction                             â”‚
â”‚    â€¢ Reads realm_access.roles array            â”‚
â”‚    â€¢ Maps to GrantedAuthority objects          â”‚
â”‚    â€¢ Adds "ROLE_" prefix                       â”‚
â”‚                                                â”‚
â”‚ â‘¦ SecurityContext Population                  â”‚
â”‚    â€¢ Creates JwtAuthenticationToken            â”‚
â”‚    â€¢ Stores in SecurityContextHolder           â”‚
â”‚    â€¢ Available to @PreAuthorize checks         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @PreAuthorize("hasRole('ADMIN')")             â”‚
â”‚ â€¢ Spring checks SecurityContext                â”‚
â”‚ â€¢ Evaluates SpEL expression                    â”‚
â”‚ â€¢ Grants/denies method access                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ (If authorized)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Controller Method Executes                     â”‚
â”‚ â€¢ Business logic runs                          â”‚
â”‚ â€¢ Database operations                          â”‚
â”‚ â€¢ Returns response                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### JWT Token Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    JWT TOKEN ANATOMY                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Format: HEADER.PAYLOAD.SIGNATURE (all Base64URL encoded)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HEADER (Algorithm & Token Type)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                            â”‚
â”‚   "alg": "RS256",    â† RSA Signature with SHA-256          â”‚
â”‚   "typ": "JWT",      â† JSON Web Token                       â”‚
â”‚   "kid": "J-idQ..."  â† Key ID (which public key to use)    â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAYLOAD (Claims - User Identity & Authorization)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                            â”‚
â”‚   // Standard Claims                                        â”‚
â”‚   "exp": 1762272840,        â† Expiration (Unix timestamp)  â”‚
â”‚   "iat": 1762272540,        â† Issued at                    â”‚
â”‚   "iss": "http://localhost:8180/realms/...", â† Issuer      â”‚
â”‚   "sub": "8667b866-...",    â† Subject (Keycloak User ID)   â”‚
â”‚   "typ": "Bearer",          â† Token type                    â”‚
â”‚                                                              â”‚
â”‚   // User Identity Claims                                   â”‚
â”‚   "preferred_username": "admin1",                           â”‚
â”‚   "email": "admin1@pharmachain.ma",                         â”‚
â”‚   "given_name": "Admin",                                    â”‚
â”‚   "family_name": "One",                                     â”‚
â”‚   "name": "Admin One",                                      â”‚
â”‚                                                              â”‚
â”‚   // Authorization Claims (CRITICAL for access control)     â”‚
â”‚   "realm_access": {                                         â”‚
â”‚     "roles": [                                              â”‚
â”‚       "ADMIN",              â† Used by @PreAuthorize        â”‚
â”‚       "offline_access",                                     â”‚
â”‚       "uma_authorization"                                   â”‚
â”‚     ]                                                        â”‚
â”‚   },                                                         â”‚
â”‚                                                              â”‚
â”‚   // Custom Attributes                                      â”‚
â”‚   "code": "300001",         â† Business-specific data       â”‚
â”‚   "secteurName": "Casablanca",                              â”‚
â”‚                                                              â”‚
â”‚   // Security Claims                                        â”‚
â”‚   "azp": "spring-boot-client", â† Authorized party          â”‚
â”‚   "scope": "profile email",    â† Requested scopes          â”‚
â”‚   "session_state": "beb4a736-..."                           â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SIGNATURE (Cryptographic Proof of Authenticity)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RSA_SHA256(                                                 â”‚
â”‚   base64UrlEncode(HEADER) + "." +                          â”‚
â”‚   base64UrlEncode(PAYLOAD),                                â”‚
â”‚   KEYCLOAK_PRIVATE_KEY  â† Only Keycloak has this          â”‚
â”‚ )                                                            â”‚
â”‚                                                              â”‚
â”‚ Verification:                                               â”‚
â”‚ â€¢ Spring Boot uses Keycloak's PUBLIC KEY                    â”‚
â”‚ â€¢ If signature matches â†’ Token is authentic                 â”‚
â”‚ â€¢ If signature fails â†’ Token was tampered or forged         â”‚
â”‚ â€¢ Impossible to forge without Keycloak's private key        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” Security Properties:
â€¢ Anyone can READ the token (it's Base64, not encrypted)
â€¢ Only Keycloak can CREATE valid tokens (has private key)
â€¢ Only holders of public key can VERIFY authenticity
â€¢ Tampering with any part invalidates the signature
â€¢ Short lifespan (15 min) limits damage if stolen
```

### Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SECURITY DEFENSE IN DEPTH                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: CLIENT SECRET PROTECTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… Server Actions ("use server")                            â”‚
â”‚    â€¢ Client secret stays on Next.js server                  â”‚
â”‚    â€¢ Never exposed to browser DevTools                      â”‚
â”‚    â€¢ Environment variables server-side only                 â”‚
â”‚                                                              â”‚
â”‚ âŒ Bad Practice: Calling Keycloak from browser JavaScript  â”‚
â”‚    â€¢ Would expose client_secret in network tab             â”‚
â”‚    â€¢ Anyone could steal credentials                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 2: HTTPS/TLS ENCRYPTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ All communication encrypted in transit                    â”‚
â”‚ â€¢ Prevents man-in-the-middle attacks                        â”‚
â”‚ â€¢ JWT tokens encrypted during network transmission          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 3: JWT SIGNATURE VERIFICATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Every API call validates JWT signature                    â”‚
â”‚ â€¢ Uses asymmetric cryptography (RSA-256)                    â”‚
â”‚ â€¢ Impossible to forge tokens without private key            â”‚
â”‚ â€¢ Stateless - no database lookup required                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 4: TOKEN EXPIRATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Access token: 15-minute lifespan                          â”‚
â”‚ â€¢ Refresh token: 30-minute lifespan                         â”‚
â”‚ â€¢ Limits damage window if token stolen                      â”‚
â”‚ â€¢ Forces periodic re-authentication                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 5: ROLE-BASED ACCESS CONTROL (RBAC)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Roles embedded in JWT (can't be forged)                   â”‚
â”‚ â€¢ @PreAuthorize checks at method level                      â”‚
â”‚ â€¢ Principle of least privilege                              â”‚
â”‚ â€¢ Fine-grained authorization                                â”‚
â”‚                                                              â”‚
â”‚ Example Hierarchy:                                          â”‚
â”‚   ADMIN â”€â†’ Full access to everything                       â”‚
â”‚     â”‚                                                        â”‚
â”‚     â””â”€â†’ MANAGER â”€â†’ Manage drivers, clients, deliveries     â”‚
â”‚           â”‚                                                  â”‚
â”‚           â””â”€â†’ DRIVER â”€â†’ View/update own deliveries only    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 6: DUAL DATABASE ISOLATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Keycloak DB (Port 5432)   â”‚  Business DB (Port 5433)       â”‚
â”‚ â€¢ User credentials         â”‚  â€¢ Business entities           â”‚
â”‚ â€¢ Password hashes          â”‚  â€¢ Delivery data               â”‚
â”‚ â€¢ Role definitions         â”‚  â€¢ No sensitive auth data      â”‚
â”‚ â€¢ Never accessed by app    â”‚  â€¢ Only keycloak_user_id link â”‚
â”‚                                                              â”‚
â”‚ Benefits:                                                    â”‚
â”‚ â€¢ Breach of business DB doesn't expose credentials          â”‚
â”‚ â€¢ Authentication logic completely isolated                  â”‚
â”‚ â€¢ Can scale databases independently                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 7: CORS POLICY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Whitelist only: localhost:3000, localhost:8080           â”‚
â”‚ â€¢ Prevents unauthorized origins from accessing API          â”‚
â”‚ â€¢ Blocks cross-site request forgery (CSRF)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 8: INPUT VALIDATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ @Valid annotations on DTOs                                â”‚
â”‚ â€¢ Prevents SQL injection (via JPA/Hibernate)                â”‚
â”‚ â€¢ XSS protection on frontend (React escaping)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why This Architecture is Secure

1. **Stateless Authentication** - No session hijacking, scales horizontally
2. **Cryptographic Guarantees** - RSA-256 signature = mathematically impossible to forge
3. **Separation of Concerns** - Auth, Business Logic, and Data are isolated
4. **Industry Standards** - OAuth2, OpenID Connect, JWT are battle-tested
5. **Zero Trust** - Every request validated independently
6. **Defense in Depth** - Multiple security layers, not single point of failure

---

## ğŸ’» Technology Stack

### Frontend Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| **Next.js** | 14+ | React framework with App Router, Server Actions |
| **TypeScript** | 5.x | Type-safe development |
| **React** | 18+ | UI component library |
| **React Context** | Built-in | Global state management (auth) |
| **Tailwind CSS** | 3.x | Utility-first styling |
| **Shadcn/ui** | Latest | Accessible component library |

### Backend Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| **Spring Boot** | 3.x | Enterprise Java framework |
| **Spring Security** | 6.x | OAuth2 Resource Server, JWT validation |
| **Spring Data JPA** | 3.x | Object-relational mapping |
| **Hibernate** | 6.x | JPA implementation |
| **PostgreSQL Driver** | Latest | Database connectivity |

### Authentication & IAM

| Technology | Version | Purpose |
|------------|---------|---------|
| **Keycloak** | 23.0 | Identity and Access Management |
| **OAuth2** | 2.0 | Authorization framework |
| **OpenID Connect** | 1.0 | Authentication layer on OAuth2 |
| **JWT** | Standard | JSON Web Tokens for stateless auth |

### Infrastructure

| Technology | Version | Purpose |
|------------|---------|---------|
| **Docker** | 20+ | Containerization |
| **Docker Compose** | 2+ | Multi-container orchestration |
| **PostgreSQL** | 15 | Relational database (2 instances) |

***

## âœ¨ Key Features

### 1. Enterprise Authentication
- OAuth2 Resource Owner Password Credentials (ROPC) flow
- JWT-based stateless authentication
- Automatic token refresh before expiration
- Secure client secret handling via Server Actions

### 2. Role-Based Access Control (RBAC)
- **Three-tier hierarchy**: Admin â†’ Manager â†’ Driver
- **Method-level security**: `@PreAuthorize` annotations
- **Fine-grained permissions**: Self-service endpoints (`/me` routes)
- **Role inheritance**: Admins can access all manager/driver functions

### 3. Delivery Management
- **Bordereau (Delivery Document) Management**: Create, scan, track
- **Delivery Item Tracking**: Individual package tracking with BL numbers
- **Status Workflow**: PENDING â†’ IN_PROGRESS â†’ COMPLETED
- **Proof of Delivery**: Capture notes and signatures

### 4. Transfer Workflow
- **Driver Transfer Requests**: Request bordereau reassignment
- **Approval Process**: PENDING â†’ ACCEPTED/REJECTED
- **Audit Trail**: Complete history of all transfers
- **Reason Tracking**: Mandatory explanation for transfers

### 5. Advanced Features
- **Pagination**: Efficient data loading for large datasets
- **Filtering**: Client-side and server-side filtering
- **Transactional Operations**: Database consistency with `@Transactional`
- **Exception Handling**: Centralized error responses
- **Automatic Client Creation**: During bordereau scanning

***

## ğŸš€ Getting Started

### Prerequisites

```bash
# Required software
Node.js 18+
Java 17+
Docker & Docker Compose
PostgreSQL 15 (via Docker)

# Verify installations
node --version   # v18.x.x or higher
java --version   # 17.x.x or higher
docker --version # 20.x.x or higher
```

### Quick Start (5 Minutes)

```bash
# 1. Clone repository
git clone https://github.com/yourusername/pharmachain.git
cd pharmachain

# 2. Start infrastructure (Keycloak + Databases)
cd docker
docker-compose up -d
# Wait 30 seconds for Keycloak initialization

# 3. Configure Keycloak (one-time setup)
# Open http://localhost:8180
# Follow KEYCLOAK_SETUP.md guide

# 4. Start backend
cd ../backend
# Edit application.properties (add client secret)
mvn spring-boot:run

# 5. Start frontend
cd ../frontend
# Edit .env.local (add client secret)
npm install
npm run dev

# 6. Access application
# Open http://localhost:3000
# Login: admin1 / Admin123!
```

### Environment Variables

**Frontend (.env.local)**
```env
NEXT_PUBLIC_API_URL=http://localhost:8080/api
KEYCLOAK_TOKEN_URL=http://localhost:8180/realms/spring-boot-realm/protocol/openid-connect/token
KEYCLOAK_CLIENT_ID=spring-boot-client
KEYCLOAK_CLIENT_SECRET=<from_keycloak_admin_console>
```

**Backend (application.properties)**
```properties
spring.datasource.url=jdbc:postgresql://localhost:5433/pharmachain_db
spring.security.oauth2.resourceserver.jwt.issuer-uri=http://localhost:8180/realms/spring-boot-realm
keycloak.credentials.secret=<from_keycloak_admin_console>
```

***

## ğŸ“ Project Structure

### Frontend Architecture

```
frontend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ actions/              # Server Actions (Keycloak communication)
â”‚   â”œâ”€â”€ login/                # Authentication pages
â”‚   â””â”€â”€ layout.tsx            # Root layout with AuthProvider
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/                 # Authentication guards & protection
â”‚   â”œâ”€â”€ ui/                   # Reusable UI components (shadcn)
â”‚   â””â”€â”€ *-management.tsx      # Feature-specific components
â”‚
â””â”€â”€ lib/
    â”œâ”€â”€ auth-context.tsx      # Auth state management
    â”œâ”€â”€ api-client.ts         # API client with JWT injection
    â””â”€â”€ utils-pharma.ts       # Business logic utilities
```

### Backend Architecture

```
backend/src/main/java/ma/pharmachain/
â”œâ”€â”€ config/                   # Security, Keycloak, CORS configuration
â”œâ”€â”€ controller/               # REST API endpoints
â”œâ”€â”€ service/                  # Business logic layer
â”œâ”€â”€ repository/               # Data access layer (JPA)
â”œâ”€â”€ entity/                   # Database entities
â”œâ”€â”€ dto/                      # Data Transfer Objects
â””â”€â”€ exception/                # Exception handling
```

***

## ğŸ—„ Database Architecture

### Dual-Database Design

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE ARCHITECTURE                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Keycloak Database         â”‚    â”‚   Business Database         â”‚
â”‚   (Port 5432)               â”‚    â”‚   (Port 5433)               â”‚
â”‚                             â”‚    â”‚                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ user_entity             â”‚ â”‚    â”‚ â”‚ users                   â”‚ â”‚
â”‚ â”‚ â€¢ id (UUID)             â”‚ â”‚â—„â”€â”€â”€â”¼â”€â”¤ â€¢ id (BIGINT)           â”‚ â”‚
â”‚ â”‚ â€¢ username              â”‚ â”‚    â”‚ â”‚ â€¢ keycloak_user_id (FK) â”‚ â”‚
â”‚ â”‚ â€¢ email                 â”‚ â”‚    â”‚ â”‚ â€¢ code                  â”‚ â”‚
â”‚ â”‚ â€¢ enabled               â”‚ â”‚    â”‚ â”‚ â€¢ user_type             â”‚ â”‚
â”‚ â”‚ â€¢ email_verified        â”‚ â”‚    â”‚ â”‚ â€¢ created_at            â”‚ â”‚
â”‚ â”‚ â€¢ created_timestamp     â”‚ â”‚    â”‚ â”‚ â€¢ synced_at             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚                         â”‚ â”‚
â”‚                             â”‚    â”‚ â”‚ Discriminator:          â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ â€¢ ADMIN                 â”‚ â”‚
â”‚ â”‚ credential              â”‚ â”‚    â”‚ â”‚ â€¢ MANAGER (+ secteur)   â”‚ â”‚
â”‚ â”‚ â€¢ id                    â”‚ â”‚    â”‚ â”‚ â€¢ DRIVER (+ license)    â”‚ â”‚
â”‚ â”‚ â€¢ user_id (FK)          â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â€¢ type (password)       â”‚ â”‚    â”‚                             â”‚
â”‚ â”‚ â€¢ secret_data (hash)    â”‚ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ algorithm (PBKDF2)    â”‚ â”‚    â”‚ â”‚ clients                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚ â€¢ id                    â”‚ â”‚
â”‚                             â”‚    â”‚ â”‚ â€¢ code                  â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ â€¢ name                  â”‚ â”‚
â”‚ â”‚ realm                   â”‚ â”‚    â”‚ â”‚ â€¢ secteur_id (FK)       â”‚ â”‚
â”‚ â”‚ â€¢ id                    â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â€¢ name                  â”‚ â”‚    â”‚                             â”‚
â”‚ â”‚ â€¢ enabled               â”‚ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚ bordereaux              â”‚ â”‚
â”‚                             â”‚    â”‚ â”‚ â€¢ id                    â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ â€¢ number                â”‚ â”‚
â”‚ â”‚ realm_role              â”‚ â”‚    â”‚ â”‚ â€¢ status                â”‚ â”‚
â”‚ â”‚ â€¢ id                    â”‚ â”‚    â”‚ â”‚ â€¢ client_id (FK)        â”‚ â”‚
â”‚ â”‚ â€¢ name (ADMIN/MANAGER)  â”‚ â”‚    â”‚ â”‚ â€¢ secteur_id (FK)       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚ â€¢ current_driver_id(FK) â”‚ â”‚
â”‚                             â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                             â”‚
â”‚ â”‚ user_role_mapping       â”‚ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â€¢ user_id (FK)          â”‚ â”‚    â”‚ â”‚ delivery_items          â”‚ â”‚
â”‚ â”‚ â€¢ role_id (FK)          â”‚ â”‚    â”‚ â”‚ â€¢ id                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚ â€¢ bl_number             â”‚ â”‚
â”‚                             â”‚    â”‚ â”‚ â€¢ bordereau_id (FK)     â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ â€¢ status                â”‚ â”‚
â”‚ â”‚ user_attribute          â”‚ â”‚    â”‚ â”‚ â€¢ proof_notes           â”‚ â”‚
â”‚ â”‚ â€¢ user_id (FK)          â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ â€¢ name (code, phone)    â”‚ â”‚    â”‚                             â”‚
â”‚ â”‚ â€¢ value                 â”‚ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”‚ bordereau_transfers     â”‚ â”‚
â”‚                             â”‚    â”‚ â”‚ â€¢ id                    â”‚ â”‚
â”‚ ğŸ”’ Security-focused         â”‚    â”‚ â”‚ â€¢ bordereau_id (FK)     â”‚ â”‚
â”‚ â€¢ Password hashing          â”‚    â”‚ â”‚ â€¢ from_driver_id (FK)   â”‚ â”‚
â”‚ â€¢ Credential management     â”‚    â”‚ â”‚ â€¢ to_driver_id (FK)     â”‚ â”‚
â”‚ â€¢ Role definitions          â”‚    â”‚ â”‚ â€¢ status                â”‚ â”‚
â”‚ â€¢ Managed by Keycloak       â”‚    â”‚ â”‚ â€¢ reason                â”‚ â”‚
â”‚ â€¢ Never accessed by app     â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                             â”‚
                                    â”‚ ğŸ“Š Business-focused         â”‚
                                    â”‚ â€¢ Domain entities           â”‚
                                    â”‚ â€¢ Relationships             â”‚
                                    â”‚ â€¢ Business logic            â”‚
                                    â”‚ â€¢ Managed by Spring JPA     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”— Linkage: users.keycloak_user_id â†â†’ user_entity.id (UUID)
```

### Entity Relationships

- **Users** (Single Table Inheritance)
  - Admin
  - Manager â†’ assigned to Admin, has many Drivers
  - Driver â†’ assigned to Manager

- **Clients** â†’ belong to Secteur (Manager)
- **Bordereaux** â†’ assigned to Client, Secteur, and Driver
- **DeliveryItems** â†’ belong to Bordereau
- **BordereauTransfers** â†’ request between Drivers for Bordereau

***

## ğŸ“¡ API Overview

### Endpoint Categories

**Authentication** (No JWT required)
- User registration

**Admin Management** (`ROLE_ADMIN` required)
- CRUD operations on all entities
- System-wide visibility

**Manager Management** (`ROLE_ADMIN` or `ROLE_MANAGER`)
- Manage drivers and clients in assigned sector
- View/manage own deliveries
- Self-service endpoints (`/me`)

**Driver Management** (`ROLE_DRIVER`)
- View assigned deliveries
- Update delivery status
- Add proof of delivery

**Bordereau & Delivery Tracking** (Role-based access)
- Create, scan, update bordereaux
- Track delivery items
- Proof of delivery capture

**Transfer Management**
- Request driver transfers
- Accept/reject transfer requests

***

## ğŸ¯ Summary

**PharmaChain** is a production-ready pharmaceutical delivery management system showcasing modern security practices:

âœ… **Stateless JWT authentication** - Scales infinitely  
âœ… **Dual-database architecture** - Security isolation  
âœ… **Zero-trust model** - Every request validated  
âœ… **Industry-standard OAuth2/OIDC** - Battle-tested protocols  
âœ… **Role-based access control** - Fine-grained permissions  
âœ… **Enterprise-grade Keycloak** - Professional IAM solution  

**Ready for production deployment with Docker, cloud-native, and horizontally scalable.**

***

### Example: Retrieve Token and decode it too as a practice
After logging in via Keycloak, the access token is automatically injected into the `Authorization: Bearer <token>` header. You can copy this token and paste it into [jwt.io](https://jwt.io) to inspect its payload, including roles, expiration, and user metadata.
<img width="1453" height="531" alt="image" src="https://github.com/user-attachments/assets/fe0a3dc6-0e3e-4f5b-96a5-a7f2521d6b18" />

### Remove authorization from admin to manger by modify one ligne code:
modify the method-level security annotation:

```java
// Original: allows both MANAGER and ADMIN
@PreAuthorize("(hasRole('MANAGER')) or (hasRole('ADMIN'))")

// Modified: restricts access to MANAGER only
@PreAuthorize("(hasRole('MANAGER'))")
```

If the current user does not have the `MANAGER` role, Spring Security will deny access and log:

```
Failed to authorize ReflectiveMethodInvocation
ExpressionAuthorizationDecision [granted=false, expressionAttribute=(hasRole('MANAGER'))]
```

This ensures strict role-based access control and prevents privilege escalation.
<img width="1511" height="481" alt="image" src="https://github.com/user-attachments/assets/98e6135e-dfd6-40e5-8cd2-87e3efe3b177" />
